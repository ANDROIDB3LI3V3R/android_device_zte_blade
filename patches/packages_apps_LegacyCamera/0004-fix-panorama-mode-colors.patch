From d376824b82b81b10b27b4d49b9caa34ba93edc2b Mon Sep 17 00:00:00 2001
From: Konsta <konsta09@gmail.com>
Date: Thu, 30 Aug 2012 11:39:55 +0300
Subject: [PATCH] fix panorama mode colors

https://github.com/rapmv78/android_packages_apps_Camera/commit/652e2f0ea6c024129b3302a346854d02c74fdaf5

Change-Id: Ib8445ecd12a38a187c800271e83d66cbe3f363f5
---
 jni/Android.mk                                     |    1 +
 .../src/mosaic_renderer/YVURenderer.cpp            |   11 ++++++++-
 jni/feature_mos_jni.cpp                            |   26 ++++++++++++++++++--
 3 files changed, 35 insertions(+), 3 deletions(-)

diff --git a/jni/Android.mk b/jni/Android.mk
index 882e3a7..a883b06 100755
--- a/jni/Android.mk
+++ b/jni/Android.mk
@@ -10,6 +10,7 @@ LOCAL_C_INCLUDES := \
         $(LOCAL_PATH)/feature_mos/src/mosaic
 
 LOCAL_CFLAGS := -O3 -DNDEBUG
+LOCAL_CFLAGS += -DCPU_COLOR_CONVERT
 
 LOCAL_SRC_FILES := \
         feature_mos_jni.cpp \
diff --git a/jni/feature_mos/src/mosaic_renderer/YVURenderer.cpp b/jni/feature_mos/src/mosaic_renderer/YVURenderer.cpp
index 9b2ad5e..9599531 100755
--- a/jni/feature_mos/src/mosaic_renderer/YVURenderer.cpp
+++ b/jni/feature_mos/src/mosaic_renderer/YVURenderer.cpp
@@ -138,6 +138,7 @@ const char* YVURenderer::VertexShaderSource() const
 
 const char* YVURenderer::FragmentShaderSource() const
 {
+#ifndef CPU_COLOR_CONVERT
     static const char gFragmentShader[] =
         "precision mediump float;\n"
         "uniform sampler2D s_texture;\n"
@@ -156,6 +157,14 @@ const char* YVURenderer::FragmentShaderSource() const
         "  p = texture2D(s_texture, v_texCoord);\n"
         "  gl_FragColor[3] = dot(p, coeff_y);\n"
         "}\n";
-
+#else
+    static const char gFragmentShader[] =
+        "precision mediump float;\n"
+        "uniform sampler2D s_texture;\n"
+        "varying vec2 v_texCoord;\n"
+        "void main() {\n"
+        "  gl_FragColor = texture2D(s_texture, v_texCoord);\n"
+        "}\n";
+#endif
     return gFragmentShader;
 }
diff --git a/jni/feature_mos_jni.cpp b/jni/feature_mos_jni.cpp
index 5458ec1..7f57ab1 100644
--- a/jni/feature_mos_jni.cpp
+++ b/jni/feature_mos_jni.cpp
@@ -354,10 +354,32 @@ void ConvertYVUAiToPlanarYVU(unsigned char *planar, unsigned char *in, int width
 
     for (int i = 0; i < planeSize; i++)
     {
+#ifndef CPU_COLOR_CONVERT
         *Yptr++ = *in++;
-        *Vptr++ = *in++ + 128; // Adjust for greenish tint
-        *Uptr++ = *in++ + 90;
+        *Vptr++ = *in++;
+        *Uptr++ = *in++;
         in++;   // Alpha
+#else // CPU_COLOR_CONVERT
+        int y, v, u;
+
+        y = (  66 * in[0] + 152 * in[1] +  25 * in[2] + 16);
+        v = ( 112 * in[0] -  94 * in[1] -  18 * in[2] + 128);
+        u = (- 38 * in[0] -  75 * in[1] + 112 * in[2] + 128);
+
+        y >>= 8;
+        v >>= 8;
+        u >>= 8;
+
+        y += 16;
+        v += 128;
+        u += 128;
+
+        *Yptr++ = (unsigned char) (y);
+        *Vptr++ = (unsigned char) (v);
+        *Uptr++ = (unsigned char) (u);
+        in += 4;   // Alpha
+
+#endif // CPU_COLOR_CONVERT
     }
 }
 
-- 
1.7.9.5

