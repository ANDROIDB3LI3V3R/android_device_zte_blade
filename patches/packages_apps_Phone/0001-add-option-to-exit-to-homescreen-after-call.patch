From c1b48face8126f0d80848b19eabe8d5a0d43724c Mon Sep 17 00:00:00 2001
From: Konsta <konsta09@gmail.com>
Date: Sat, 1 Sep 2012 10:36:08 +0300
Subject: [PATCH] add option to exit to homescreen after call

ported from aokp

Change-Id: Ie1e94ec494c9ceb79488084034e38a83dd7edef1
---
 res/values/strings.xml                         |    4 ++++
 res/xml/call_feature_setting.xml               |    5 +++++
 src/com/android/phone/CallFeaturesSetting.java |    5 +++++
 src/com/android/phone/InCallScreen.java        |   15 +++++++++++++++
 4 files changed, 29 insertions(+)

diff --git a/res/values/strings.xml b/res/values/strings.xml
index 0c03f08..4fe067a 100644
--- a/res/values/strings.xml
+++ b/res/values/strings.xml
@@ -1514,4 +1514,8 @@
     <string name="vibrate_call_waiting">Vibrate call waiting</string>
     <string name="vibrate_call_waiting_sum">Vibrate on call waiting</string>
     <!-- End Advanced Settings -->
+
+    <!-- Exit to home screen setting -->
+    <string name="exit_to_home_screen_title">Exit to home screen</string>
+    <string name="exit_to_home_screen_summary">Exit to home screen when call ends instead of call log</string>
 </resources>
diff --git a/res/xml/call_feature_setting.xml b/res/xml/call_feature_setting.xml
index 05ea53d..ef84fc0 100644
--- a/res/xml/call_feature_setting.xml
+++ b/res/xml/call_feature_setting.xml
@@ -57,6 +57,11 @@
         android:title="@string/vibrate_call_waiting"
         android:persistent="true"
         android:summary="@string/vibrate_call_waiting_sum"/>
+     <CheckBoxPreference
+        android:key="button_exit_to_home_screen_key"
+        android:title="@string/exit_to_home_screen_title"
+        android:persistent="true"
+        android:summary="@string/exit_to_home_screen_summary"/>
   </PreferenceCategory>
 
   <PreferenceCategory
diff --git a/src/com/android/phone/CallFeaturesSetting.java b/src/com/android/phone/CallFeaturesSetting.java
index 98502f2..7ab313f 100644
--- a/src/com/android/phone/CallFeaturesSetting.java
+++ b/src/com/android/phone/CallFeaturesSetting.java
@@ -179,6 +179,8 @@ public class CallFeaturesSetting extends PreferenceActivity
 
     private static final String VM_NUMBERS_SHARED_PREFERENCES_NAME = "vm_numbers";
 
+    private static final String BUTTON_EXIT_TO_HOMESCREEN_KEY = "button_exit_to_home_screen_key";
+
     private static final String BUTTON_SIP_CALL_OPTIONS =
             "sip_call_options_key";
     private static final String BUTTON_SIP_CALL_OPTIONS_WIFI_ONLY =
@@ -267,6 +269,7 @@ public class CallFeaturesSetting extends PreferenceActivity
     private PreferenceScreen mVoicemailSettings;
     private ListPreference mVoicemailNotificationVibrateWhen;
     private SipSharedPreferences mSipSharedPreferences;
+    private CheckBoxPreference mButtonExitToHomeScreen;
 
     private class VoiceMailProvider {
         public VoiceMailProvider(String name, Intent intent) {
@@ -1531,6 +1534,8 @@ public class CallFeaturesSetting extends PreferenceActivity
             }
         }
 
+        mButtonExitToHomeScreen = (CheckBoxPreference) findPreference(BUTTON_EXIT_TO_HOMESCREEN_KEY);
+
         mButtonDTMF = (ListPreference) findPreference(BUTTON_DTMF_KEY);
         mButtonAutoRetry = (CheckBoxPreference) findPreference(BUTTON_RETRY_KEY);
         mButtonHAC = (CheckBoxPreference) findPreference(BUTTON_HAC_KEY);
diff --git a/src/com/android/phone/InCallScreen.java b/src/com/android/phone/InCallScreen.java
index 9f8ec31..ac93e31 100755
--- a/src/com/android/phone/InCallScreen.java
+++ b/src/com/android/phone/InCallScreen.java
@@ -32,6 +32,7 @@ import android.content.DialogInterface;
 import android.content.DialogInterface.OnCancelListener;
 import android.content.Intent;
 import android.content.IntentFilter;
+import android.content.SharedPreferences;
 import android.content.res.Configuration;
 import android.content.res.Resources;
 import android.graphics.Typeface;
@@ -43,6 +44,7 @@ import android.os.Message;
 import android.os.PowerManager;
 import android.os.SystemClock;
 import android.os.SystemProperties;
+import android.preference.PreferenceManager;
 import android.telephony.ServiceState;
 import android.text.TextUtils;
 import android.text.method.DialerKeyListener;
@@ -161,6 +163,8 @@ public class InCallScreen extends Activity
     private static final int PHONE_INCOMING_RING = 123;
     private static final int PHONE_NEW_RINGING_CONNECTION = 124;
 
+    private static final String BUTTON_EXIT_TO_HOMESCREEN_KEY = "button_exit_to_home_screen_key";
+
     // When InCallScreenMode is UNDEFINED set the default action
     // to ACTION_UNDEFINED so if we are resumed the activity will
     // know its undefined. In particular checkIsOtaCall will return
@@ -260,6 +264,7 @@ public class InCallScreen extends Activity
         EARPIECE,   // Handset earpiece (or wired headset, if connected)
     }
 
+    public boolean mExitToHomeScreen = false;
 
     private Handler mHandler = new Handler() {
         @Override
@@ -458,6 +463,8 @@ public class InCallScreen extends Activity
             return;
         }
 
+        updateSettings();
+
         mApp = PhoneApp.getInstance();
         mApp.setInCallScreenInstance(this);
 
@@ -548,6 +555,8 @@ public class InCallScreen extends Activity
         if (DBG) log("onResume()...");
         super.onResume();
 
+        updateSettings();
+
         mIsForegroundActivity = true;
         mIsForegroundActivityForProximity = true;
 
@@ -2679,6 +2688,7 @@ public class InCallScreen extends Activity
                         log("- Show Call Log (or Dialtacts) after disconnect. Current intent: "
                                 + intent);
                     }
+                    if (!mExitToHomeScreen)
                     try {
                         startActivity(intent, opts.toBundle());
                     } catch (ActivityNotFoundException e) {
@@ -4638,4 +4648,9 @@ public class InCallScreen extends Activity
             log("Requested to remove provider info after " + PROVIDER_INFO_TIMEOUT + " msec.");
         }
     }
+
+    protected void updateSettings() {
+        SharedPreferences callsettings = PreferenceManager.getDefaultSharedPreferences(this);
+        mExitToHomeScreen = callsettings.getBoolean(BUTTON_EXIT_TO_HOMESCREEN_KEY, false);
+    }
 }
-- 
1.7.9.5

